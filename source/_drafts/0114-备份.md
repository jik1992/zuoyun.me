title: 备份
date: 2016/03/03 03:20:57
categories:
 - tryghost

tags:
 - 未归档 



---

遇到问题的时候
技术A: 欧洲 我的项目怎么访问不了....
我:   xx项目?xx机器?xx情况
….
巴拉巴拉.....来回问了好几轮.....好几分钟过去了
可能技术A已经发现出问题了,但是不知道是什么原因.
现在我把一些我经常遇到的一些问题,又是如何快速定位的总结了一下
提问需要智慧
说出你能描述的最详细的情况(比如IP, 报错内容摘要)
不要问 "在吗?”  “我的项目访问不了”   “发布系统编译不了了”
至少自己去查阅过资料,自己动过手

例如:   xxIP  CPU占用好高 , TOP里看是某个项目一直在占用
           xx 域名的部分url打开好慢
           xxIP调用API有提示网络无法连接 
操作系统资源 (  一般来说资源问题都是由上层应用引起的 )
CPU
load飙高
某一个进程cpu使用频繁
命令: top
可以通过[top] 快速定位pid  以及对应的进程  再进一步排查问题
top -H pid      查看进程内线程的cpu排序
这里的到是10进制的
需要转换为16进制 与jstack 里的线程对应上
案例
某时期水印的一个web一发布,对应的机器load飙高
内核进程频繁占用cpu资源见[内存其他组件内存泄露]
io wait很高
df -h  :  按磁盘分组查看
iostat : 可以按磁盘分组 查看IOPS 读写量 ...
iotop :  可以分析除某一个进程使用IO比较大
案例
某天一台机器硬盘满了,然后应用大量报错导致cpu飙高
某天API不可用,应用大量错误抛出,写IO导致cpu飙高
内存
其他组件内存泄露
运行了使用NFS文件系统的应用程序后，内存缓慢泄漏,最后导致整个服务器的内存全部耗尽，系统调起多个pdflush进程，并占到CPU的99%
JAVA应用内存泄露
堆内
ps -aux | grep java 
jmap -heap pid  
jmap -histo:live pid 
jstata -gcutil pid  1000 1000  查看gc情况
堆外
堆外内存泄露排查比较难,没有实际相关处理经验
磁盘
磁盘容量写满
metaQ 在遇到磁盘写满之后,会有消息丢失.无法消费. 甚至无法重启的故障(需要手动修复)
IO能力不足
网络
请看网络篇了解基础知识
流量跑满 
大量请求
前端错误采集上报直接把机器内网流量跑满,故障持续了接近3小时
由于是在nginx做负载的,所以要把用户的流量全部接收  等于是我们的大量用户对我们造成DDOS攻击 
某应用内新发布的版本ICON图片 大约 5-6张,每张2M
用户一打开就是一个12M的流量请求
某运营活动页 一个动态效果,通过修改 <img>标签的src 造成了大量的请求
双11业务高峰
双11前后几天太多了....
机器之间无法访问
结合我们的实际场景  一般是几个护城河 不能互通的问题
JAVA应用
业务异常
访问慢
先看看系统资源是否充足
看看堆栈情况卡在哪一行代码 ( jstack pid  )
一般情况
数据库语句慢
代码有死循环
外部接口超时
观察错误日志
应用的error日志
容器的日志
内存泄露
命令
ps -aux | grep java                  可以查看实际内存占用情况
jmap -heap pid                        查看堆内存占用情况
jmap -histo:livepid                  查看堆内实例数量与内存占用情况      加live是强制full gc一次
这里可以知道某个类占用特别大 review代码提交记录 可以看出大部分异常
jstat -gcutil pid  1000 1000     查看gc情况次数/总耗时
内存dump  这个需要慢慢看了 不能说快速了
案例
太多了...不一一列举
内存溢出
堆溢出
内存泄露之后 jvm 无法gc
Perm区溢出
动态加载的class过多
ibatis 有一个版本在跟cglib结合使用的时候会尝试大量的pojo内部类
jsp过多
无法创建新的线程
jdk1.5里 默认的栈空间是1M 也就是说  100个线程啥也不干就占用了100M内存  (jdk版本栈空间大小有差异)
受限操作系统的文件打开数 google: ulimit
栈溢出
AOP配置不当
ERP这边有一次配置不当的情况下jvm 触发了栈溢出, 但是那个版本的jdk有bug 栈溢出之后没有任何异常抛出,jvm进程直接挂掉
正则表达式配置不当
安装卸载服务的时候一般会对用户的详情做替换,正则不够优化的时候,会触发死循环
递归退出的条件有问题
有死循环代码
外部组件/接口/缓存
缓存没有设置过期时间
某应用设置了一个key, 在发布新的版本之后,出现ClassCastException 
缓存写爆咯
外部中间件的问题比较难排查,开源的java版本的还好,可以对照源码
metaQ  
OCS内部节点丢失
导致部分用户会话失效,应用无法访问
系统越来越复杂,问题可能会越来越奇葩,但是出问题都是一些小环节,引发的   还有很多没有想到....想到再补充



